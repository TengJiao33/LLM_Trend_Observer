import json
import os
from datetime import datetime
from compare import DeltaEngine

class ReportGenerator:
    def __init__(self, output_dir="reports"):
        self.output_dir = output_dir
        os.makedirs(self.output_dir, exist_ok=True)
        self.engine = DeltaEngine()

    def _format_delta(self, delta):
        if delta == "New":
            return "ğŸ†• **New**"
        elif "â†‘" in delta:
            return f"ğŸŸ¢ {delta}"
        elif "â†“" in delta:
            return f"ğŸ”´ {delta}"
        else:
            return "âšª -"

    def generate(self):
        now = datetime.now()
        timestamp_str = now.strftime("%Y-%m-%d %H:%M:%S")
        filename = f"report_{now.strftime('%Y%m%d_%H%M%S')}.md"
        filepath = os.path.join(self.output_dir, filename)

        # Load Current Data
        or_data = []
        lmsys_data = []
        
        if os.path.exists("data/openrouter_current.json"):
            with open("data/openrouter_current.json", "r", encoding="utf-8") as f:
                or_data = json.load(f)
        
        if os.path.exists("data/lmsys_current.json"):
            with open("data/lmsys_current.json", "r", encoding="utf-8") as f:
                lmsys_data = json.load(f)

        # Get Deltas
        or_reports = self.engine.compare("openrouter", or_data)
        lmsys_reports = self.engine.compare("lmsys", lmsys_data)

        # Build Markdown
        md = f"""# ğŸ¤– å¤§æ¨¡å‹ä»Šæ—¥è¶‹åŠ¿-{now.strftime('%m-%d')}

> ğŸ“… **ç”Ÿæˆæ—¶é—´**: `{timestamp_str}`
> ğŸ“Š **æ•°æ®æº**: [OpenRouter Rankings](https://openrouter.ai/rankings) & [LMSYS Leaderboard](https://lmarena.ai/leaderboard)

---

## ğŸš€ OpenRouter æ’è¡Œæ¦œ (Top 10)
*åŸºäº OpenRouter å¹³å°çœŸå®éƒ¨ç½²ä¸è°ƒç”¨é‡ç»Ÿè®¡*

| æ’å | æ¨¡å‹ ID | ä½¿ç”¨é‡ (Tokens) | å¢é•¿ç‡ | å˜åŠ¨ |
| :--- | :--- | :--- | :--- | :--- |
"""
        for item in or_reports[:10]:
            delta_styled = self._format_delta(item['delta'])
            # Extract new metrics from or_data corresponding to item
            curr_item = next((x for x in or_data if x['model_id'] == item['model_id']), {})
            tokens = curr_item.get('tokens', '-')
            growth = curr_item.get('growth', '-')
            md += f"| {item['rank']} | `{item['model_id']}` | {tokens} | {growth} | {delta_styled} | \n"

        md += f"""
---

## ğŸ† LMSYS Chatbot Arena (Top 10)
*åŸºäºä¼—æµ‹ç«æŠ€åœº Elo åˆ†æ•°ç»Ÿè®¡*

| æ’å | æ¨¡å‹åç§° | Elo åˆ†æ•° | æŠ•ç¥¨æ•° | å˜åŠ¨ |
| :--- | :--- | :--- | :--- | :--- |
"""
        for item in lmsys_reports[:10]:
            delta_styled = self._format_delta(item['delta'])
            # Extract new metrics
            curr_item = next((x for x in lmsys_data if x['model_id'] == item['model_id']), {})
            votes = curr_item.get('votes', '-')
            md += f"| {item['rank']} | **{item['model_id']}** | {item['score']} | {votes} | {delta_styled} | \n"

        # Special Analysis Section
        md += "\n--- \n\n## ğŸ” æ˜¾è‘—å˜åŠ¨ä¸æ–°æ¨¡å‹\n"
        
        new_models = [r['model_id'] for r in or_reports + lmsys_reports if r['delta'] == "New"]
        big_ups = [r['model_id'] for r in or_reports + lmsys_reports if "â†‘" in r['delta'] and int(r['delta'][1:]) >= 2]
        
        if new_models:
            md += "### ğŸ†• æ–°ä¸Šæ¦œæ¨¡å‹\n"
            for m in new_models[:5]:
                md += f"- `{m}`\n"
        
        if big_ups:
            md += "\n### ğŸ“ˆ è¡¨ç°å¼ºåŠ² (æ’åä¸Šå‡ >= 2)\n"
            for m in big_ups[:5]:
                md += f"- `{m}`\n"

        if not new_models and not big_ups:
            md += "æœ¬æœŸæ’åç›¸å¯¹ç¨³å®šï¼Œæœªæ£€æµ‹åˆ°æ˜¾è‘—å¼‚å¸¸å˜åŠ¨ã€‚\n"

        md += "\n---\n*Report generated by LLM Trend Observer System*"

        with open(filepath, "w", encoding="utf-8") as f:
            f.write(md)
        
        # Also update a 'latest_report.md' for constants links
        with open(os.path.join(self.output_dir, "latest_report.md"), "w", encoding="utf-8") as f:
            f.write(md)

        print(f"Report generated: {filepath}")
        return filepath


